@page "/search"

@using QuotelyAPP.Models
@using QuotelyAPP.Services
@inject QuoteService QuoteService
@inject FavoritesService FavoritesService
@using System.Linq

<h2>Search Quotes</h2>
<p>Find the perfect words for any occasion</p>

<div style="display:flex; gap:20px; margin-bottom:20px; max-width:900px;">
    <input placeholder="Search by keyword (optional)"
           @bind="keyword"
           @bind:event="oninput"
           style="flex:1; padding:12px;" />

    <div style="flex:1; position:relative;">
        <input placeholder="Filter by author (type 3+ chars)"
               value="@author"
               @oninput="OnAuthorInput"
               style="width:100%; padding:12px;" />
        
        @if (authorSuggestions != null && authorSuggestions.Any() && author.Length >= 3)
        {
            <div style="position:absolute; top:100%; left:0; right:0; background:white; border:1px solid #ddd; z-index:1000;">
                @foreach (var a in authorSuggestions)
                {
                    <div @onclick="() => SelectAuthor(a.name)"
                         style="padding:10px; cursor:pointer; border-bottom:1px solid #eee;">
                        @a.name
                    </div>
                }
            </div>
        }
    </div>

    <select @bind="selectedTag"
            style="flex:1; padding:12px;">
        <option value="">Select a tag</option>

        @foreach (var t in tags)
        {
            <option value="@t">@t</option>
        }
    </select>
</div>


<button @onclick="SearchQuotes"
        style="width:900px; padding:14px; margin-bottom:30px;">
     Search Quotes
</button>

@if (isLoading)
{
    <p>Searching...</p>
}

@if (!string.IsNullOrEmpty(error))
{
    <p>@error</p>
}

@if (results != null && results.results.Any())
{
    <h3>Results</h3>

    @foreach (var q in results.results)
    {
        var currentQuote = q;
        var quoteId = currentQuote._id ?? "";
        var isFavorite = favoriteQuotes.ContainsKey(quoteId) && favoriteQuotes[quoteId];
        
        <div style="position:relative; margin-bottom:20px; padding:20px; padding-bottom:50px; border:1px solid #ddd; border-radius:8px;">
            <blockquote>"@currentQuote.content"</blockquote>
            <p>— @currentQuote.author</p>
            <p>Tags: @string.Join(", ", currentQuote.tags ?? new List<string>())</p>
            
            <button style="position:absolute; bottom:15px; right:15px; background:none; border:none; cursor:pointer; font-size:24px; padding:5px;" @onclick="() => ToggleFavorite(currentQuote)">
                @if (isFavorite)
                {
                    <span style="color:red;">♥</span>
                }
                else
                {
                    <span style="color:#ccc;">♡</span>
                }
            </button>
        </div>
    }
}

@code {
    string keyword = "";
    string author = "";
    string selectedTag = "";
    bool isLoading = false;
    string? error;

    QuoteSearchResult? results;
    List<Author>? authorSuggestions;
    List<string> tags = new();
    Dictionary<string, bool> favoriteQuotes = new();

    protected override async Task OnInitializedAsync()
    {
        await LoadTags();
    }

    private async Task LoadTags()
    {
        try
        {
            var tagList = await QuoteService.GetTags();
            if (tagList != null)
            {
                tags = tagList
                    .Where(t => !string.IsNullOrEmpty(t.name))
                    .Select(t => t.name!)
                    .OrderBy(t => t)
                    .ToList();
            }
        }
        catch
        {
            tags = new List<string>();
        }
    }

    private async Task SearchQuotes()
    {
        isLoading = true;
        error = null;
        results = null;
        StateHasChanged();

        try
        {
            if (string.IsNullOrWhiteSpace(keyword) && 
                string.IsNullOrWhiteSpace(author) && 
                string.IsNullOrWhiteSpace(selectedTag))
            {
                error = "Please enter a search term, author, or select a tag.";
                isLoading = false;
                StateHasChanged();
                return;
            }
            
            List<Quote> allQuotes = new List<Quote>();
            HashSet<string> seenIds = new HashSet<string>();
            
            for (int page = 1; page <= 10; page++)
            {
                var response = await QuoteService.SearchQuotes("", page: page, limit: 150);
                
                if (response?.results == null || !response.results.Any())
                    break;
                
                // Only add quotes we haven't seen before
                foreach (var quote in response.results)
                {
                    if (quote._id != null && !seenIds.Contains(quote._id))
                    {
                        allQuotes.Add(quote);
                        seenIds.Add(quote._id);
                    }
                }
                
                if (response.results.Count < 150)
                    break;
            }
            
            if (allQuotes.Count == 0)
            {
                error = "No response from API.";
                isLoading = false;
                StateHasChanged();
                return;
            }
            
            var filteredResults = allQuotes.AsEnumerable();
            
            if (!string.IsNullOrWhiteSpace(keyword))
            {
                string keywordLower = keyword.ToLowerInvariant();
                filteredResults = filteredResults
                    .Where(q => q.content != null && q.content.ToLowerInvariant().Contains(keywordLower));
            }
            
            if (!string.IsNullOrWhiteSpace(author))
            {
                string authorLower = author.ToLowerInvariant();
                filteredResults = filteredResults
                    .Where(q => q.author != null && q.author.ToLowerInvariant().Contains(authorLower));
            }
            
            if (!string.IsNullOrWhiteSpace(selectedTag))
            {
                filteredResults = filteredResults
                    .Where(q => q.tags != null && q.tags.Any(t => t != null && t.Equals(selectedTag, StringComparison.OrdinalIgnoreCase)));
            }
            
            var filteredList = filteredResults.ToList();
            results = new QuoteSearchResult
            {
                results = filteredList,
                count = filteredList.Count,
                totalCount = filteredList.Count,
                page = 1,
                totalPages = 1
            };

            // Check favorites for all results
            await UpdateFavoriteStatus();

            if (results.results == null || results.results.Count == 0)
            {
                error = "No quotes found matching your search.";
                results = null;
            }
        }
        catch (Exception ex)
        {
            error = $"Error: {ex.Message}";
            results = null;
        }
        finally
        {
            isLoading = false;
            StateHasChanged();
        }
    }

    private async Task UpdateFavoriteStatus()
    {
        if (results?.results == null)
            return;

        favoriteQuotes.Clear();
        foreach (var quote in results.results)
        {
            if (quote._id != null)
            {
                favoriteQuotes[quote._id] = await FavoritesService.IsFavoriteAsync(quote);
            }
        }
    }

    private async Task OnAuthorInput(ChangeEventArgs e)
    {
        author = e.Value?.ToString() ?? "";
        
        if (author.Length >= 3)
        {
            try
            {
                List<Author> allAuthors = new List<Author>();
                
                for (int page = 1; page <= 10; page++)
                {
                    var result = await QuoteService.SearchAuthors("", page: page, limit: 100);
                    
                    if (result?.results == null || !result.results.Any())
                        break;
                    
                    allAuthors.AddRange(result.results);
                    
                    if (result.results.Count < 100)
                        break;
                }
                
                if (allAuthors.Any())
                {
                    string authorLower = author.ToLowerInvariant();
                    authorSuggestions = allAuthors
                        .Where(a => a.name != null && a.name.ToLowerInvariant().Contains(authorLower))
                        .Take(10)
                        .ToList();
                }
                else
                {
                    authorSuggestions = null;
                }
            }
            catch
            {
                authorSuggestions = null;
            }
        }
        else
        {
            authorSuggestions = null;
        }
        
        StateHasChanged();
    }

    private void SelectAuthor(string authorName)
    {
        author = authorName;
        authorSuggestions = null;
        StateHasChanged();
    }

    private async Task ToggleFavorite(Quote quote)
    {
        if (quote?._id == null)
            return;

        await FavoritesService.ToggleFavoriteAsync(quote);
        favoriteQuotes[quote._id] = await FavoritesService.IsFavoriteAsync(quote);
        StateHasChanged();
    }
}

